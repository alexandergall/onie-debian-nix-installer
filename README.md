# onie-debian-nix-installer

A Nix function to create an ONIE installer for a system containing the
Nix package manager on top of a Debian release. Optionally, a list of
store paths can be added to the Nix store and installed in a
profile. This can be used to pre-install an application provided by
arbitrary Nix packages.

## Usage

Create a profile with the `mk-profile.sh`. The script takes the name
of a Debian release and an optional list of packages to add to the
standard list of packages to be installed in the ONIE image. For
example (this assumes that `debootstrap` is available on the system)

```
$ mk-profile.sh buster git make
```

The standard list of packages includes whatever `debootstrap` selects
by default and a set of packages added by `mk-profile.sh` (see the
definition of the `default_packages` variable in the script).

The script produces three files as output

   * `bootstrap.tar`. This is a tarball as produced by the
     `--make-tarball` option of `debootstrap` but with all `.deb`
     files removed.
   * `pkgs.nix`. A file containing a Nix expression that evaluates to
     a list with one entry per original `.deb` file. Each entry
     contains the URL from where the `.deb` file can be downloaded,
     the `sha256` hash and original Name of the Debian package.
   * `release`. A Nix expression that evaluates to a string containing
     the Debian release with which `mk-profile.sh` was called.

These files need to be copied to the project that wants to create an
ONIE installer.  Within that project's Nix expression, import this
repository and call the resulting function to build the installer

```Nix
  ## pkgs is an instance of a Nix package collection
  mkOnieInstaller = pkgs.callPackage (pkgs.fetchgit {
    url = "https://github.com/alexandergall/onie-debian-nix-installer";
    rev = "2adc7d6";
    sha256 = "0l95r97knig3pyk0zmbijpk5lih30hn3azmngk2rdjm7ag9vm12p";
  }) {};
  onieInstaller = mkOnieInstaller { ... };
```
The function takes the following arguments

   * `bootstrapProfile`. **Mandatory**. A derivation that contains the
     three files generated by `mk-profile.sh`.
   * `rootPaths`. **Optional**. A list of derivations whose closure
     will be installed in the Nix store of the image. In addition, the
     paths will be installed in the Nix profile specified by the
     `nixProfile` argument. The default is an empty list.
   * `nixProfile`. **Optional**. The path of the Nix profile in which
     the set of `rootPaths` will be installed. The default is
     `/nix/var/nix/profiles/service`.
   * `binaryCaches`. **Optional**. A list of binary caches to add to
     the Nix configuration `/etc/nix/nix.conf` in addition to the
     standard Nix binary cache. Each item in the list must be a set
     with keys
     * `url`. The URL of the cache as expected by the
       `extra-substituters` and `trusted-substituters` option of
       `nix.conf`.
     * `key`. The public key of the cache as expected by the
       `trusted-public-keys` option of `nix.conf`.
     The default is an empty list.
   * `fileTree`. **Optional**. A derivation containing a directory
     tree which will be copied onto the root file system of the image
     after `debootstrap` is executed. The default is an empty tree.
   * `rootPassword`. **Optional**. The root password in clear
     text. Root logins are only allowed on the serial console when the
     image boots for the first time. The default is an empty string.
   * `activationCmd`. **Optional**. The command to execute after the
     `rootPaths` have been installed in `nixProfile`. It can be used
     to initialize a service provided by `rootPaths`. The default is
     an empty string, which skips activation.
   * `installerName`. **Optional**. The name of the final ONIE
     installer executable. The default is `onie-installer.bin`.
   * `NOS`. **Optional**. The name of the "Network Operating System"
     (in ONIE terminology). This name is used in the partition label
     of the Debian root partition and informational messages issued
     during the install. The default is the string `NOS`.
   * `grubDefault`. **Optional**. A derivation containing the default
     GRUB configuration to be copied to `/etc/default/grub`.  The default is
     ```
     GRUB_DEFAULT=0
     GRUB_TIMEOUT=5
     GRUB_DISTRIBUTOR="NOS"
     GRUB_CMDLINE_LINUX_DEFAULT="console=ttyS0"
     GRUB_CMDLINE_LINUX=""
     GRUB_TERMINAL="console"
     ```
	 Alternatively, `/etc/default/grub` can also be set through
	 `fileTree`.
   * `component`. **Optional**. An arbitrary string that will be
     written to a file named `component` in the derivation produced by
     this function. It can be used by the Hyrda CI system to perform
     some action in the `post-build-hook` (e.g. copy it to a location
     where it can be made available for download). The default is an
     empty string.
   * `version`. **Optional**. An aribtrary sring conveying version
     information about the service provided by `rootPaths`. It is
     written to a file named `version` in the derivation produced by
     this function. The purpose is the same as that of
     `component`. The default is an empty string.

The installer is built in a VM, i.e. the build host must provide the
`kvm` feature. The build proceeds as follows:

   * Use `bootstrap-from-profile.nix` to re-create the original
     `debootstrap` tarball from `boootstrapProfile`.
   * Create an empty directory for the root file system and use it as
     a chroot for all following actions.
   * Call `debootstrap` to create the base root file system
   * Set `localhost` as host name.
   * Copy `grubDefault` to `/etc/default/grub`
   * Copy `fileTree` to the root file system. This can overwrite the
     host name and set the time zone and locale if desired, for
     example.
   * Set the root password to `rootPassword`
   * Install Nix in multi-user mode. The installer is called with the
     options
        * `--no-channel-add`
        * `--no-modify-profile`
        * `--daemon-user-count 12`
   * Add binary caches
   * If `rootPaths` is not an empty list
      * Copy the closure of `rootPaths` to the Nix store
      * Install `rootPaths` in profile `nixProfile`
      * Call `activationCmd`

The final root file system is then archived and compressed with
`xz`. The installer is created as a self-extracting archive using the
convetions expected by ONIE.

The installer can be executed on a target booted into ONIE "install
mode" with

```
ONIE# onie-nos-install <FILE|URL>
```

The installer wipes all partitions beyond partitions 1 and 2 (the EFI
boot loader and the ONIE installer).

The Debian system can be upgraded at will, including new kernels and
modifications to the GRUB boot loader.  The boot menu, apart from the
standard Debian boot menu entries, also has an entry called "ONIE" to
chain-load the ONIE partition. This can be used to install another NOS
or use the ONIE recovery feature.
